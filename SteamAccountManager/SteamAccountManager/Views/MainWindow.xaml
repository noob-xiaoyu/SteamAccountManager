<!-- Views/MainWindow.xaml -->
<Window x:Class="SteamAccountManager.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SteamAccountManager"
        xmlns:vm="clr-namespace:SteamAccountManager.ViewModels"
        xmlns:helpers="clr-namespace:SteamAccountManager.Helpers"
        mc:Ignorable="d"
        Title="Steam 账号管理器" Height="600" Width="900"
        Background="#2D2D30" Foreground="White">
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <!-- =================================================================== -->
    <!-- 资源定义: 转换器和所有控件的暗黑主题样式都定义在这里 -->
    <!-- =================================================================== -->
    <Window.Resources>
        <!-- 功能性资源 -->
        <helpers:InverseBooleanConverter x:Key="InverseBooleanConverter"/>

        <!-- 按钮样式 -->
        <Style TargetType="Button">
            <Setter Property="Background" Value="#3E3E42"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#555"/>
            <Setter Property="Padding" Value="10,5"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}" CornerRadius="3">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#555557"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="#007ACC"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- DataGrid 整体样式 -->
        <Style TargetType="DataGrid">
            <Setter Property="Background" Value="#2D2D30"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#555"/>
            <Setter Property="HorizontalGridLinesBrush" Value="#444"/>
            <Setter Property="VerticalGridLinesBrush" Value="Transparent"/>
        </Style>

        <!-- DataGrid 表头样式 -->
        <Style TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="#3E3E42"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#555"/>
            <Setter Property="BorderThickness" Value="0,0,1,1"/>
            <Setter Property="Padding" Value="5"/>
        </Style>

        <!-- DataGrid 行样式 -->
        <Style TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent"/>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#007ACC"/>
                    <Setter Property="Foreground" Value="White"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- DataGrid 单元格样式 -->
        <Style TargetType="DataGridCell">
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="Foreground" Value="White"/>
                </Trigger>
            </Style.Triggers>
        </Style>

    </Window.Resources>

    <!-- 主布局 -->
    <DockPanel>
        <!-- Status Bar (放在顶部定义，但显示在底部) -->
        <StatusBar DockPanel.Dock="Bottom" Background="#007ACC">
            <StatusBarItem>
                <!-- [修复] 绑定到 StatusText -->
                <TextBlock Text="{Binding StatusText}" Foreground="White"/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <TextBlock>
                    <Hyperlink NavigateUri="https://github.com/noob-xiaoyu/SteamAccountManager" RequestNavigate="Hyperlink_RequestNavigate" Foreground="White">
                        GitHub
                    </Hyperlink>
                </TextBlock>
            </StatusBarItem>
        </StatusBar>

        <!-- =================================================================== -->
        <!-- 主要内容区域，绑定 IsEnabled 以在繁忙时禁用 -->
        <!-- =================================================================== -->
        <DockPanel IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBooleanConverter}}">
            <!-- Top Toolbar -->
            <Border DockPanel.Dock="Top" Padding="5" BorderBrush="#444" BorderThickness="0,0,0,1">
                <StackPanel Orientation="Horizontal">
                    <!-- [修复] 绑定批量添加命令 -->
                    <Button Content="➕批量添加➕" Command="{Binding BulkAddCommand}" Height="23" Width="88"/>
                    <Button Content="✏️更改选中✏️" Command="{Binding EditAccountCommand}" Height="23" Width="90"/>
                    <Button Content="🚀启动 Steam 登录🚀" Command="{Binding LoginCommand}" Height="23"/>
                    <Button Content="🗑️⚠️删除选中⚠️🗑️" Margin="2" Padding="10,5" Height="23" Command="{Binding DeleteAccountCommand}" CommandParameter="{Binding ElementName=AccountsGrid, Path=SelectedItems}"/>
                    <Button Content="🔄批量更新昵称 (API)🔄" Command="{Binding BatchUpdateNicknameCommand}"/>
                    <Button Content="🛡️更新封禁状态 (API)🛡️" Command="{Binding UpdateBanStatusCommand}"/>
                </StackPanel>
            </Border>

            <!-- API Key Input -->
            <Border DockPanel.Dock="Top" Padding="8">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Steam Web API Key:" VerticalAlignment="Center" Margin="2"/>
                    <TextBox Width="300" Text="{Binding ApiKey, UpdateSourceTrigger=PropertyChanged}" Margin="5,0"
                             Background="#3E3E42" Foreground="White" BorderBrush="#555"/>
                    <TextBlock Margin="10,0,0,0">
                        <Hyperlink NavigateUri="https://steamcommunity.com/dev/apikey" RequestNavigate="Hyperlink_RequestNavigate">
                            获取 Steam API
                        </Hyperlink>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- Main DataGrid -->
            <DataGrid ItemsSource="{Binding Accounts}"
                      x:Name="AccountsGrid"
                      Margin="5"
                      AutoGenerateColumns="False"
                     CanUserAddRows="False"
                     SelectionMode="Extended"
                     IsReadOnly="True"
                      AlternatingRowBackground="#E8F5E9"
                      CanUserSortColumns="False"
                     GridLinesVisibility="Horizontal" Foreground="Black">
                <!-- [修复] 移除了冲突的 AlternatingRowBackground 和 Background 属性，由 Style 控制 -->
                <DataGrid.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="🚀登录选中账号🚀" Command="{Binding LoginCommand}"/>
                        <MenuItem Header="✏️更改选中账号✏️" Command="{Binding EditAccountCommand}"/>
                        <Separator/>
                        <MenuItem Header="🛡️更新状态 (API)🛡️" Command="{Binding UpdateStatusCommand}"/>
                        <MenuItem Header="🔄更新昵称 (API)🔄" Command="{Binding BatchUpdateNicknameCommand}"/>
                        <Separator/>
                        <MenuItem Header="🗑️⚠️删除选中账号⚠️🗑️" Command="{Binding DeleteAccountCommand}" CommandParameter="{Binding ElementName=AccountsGrid, Path=SelectedItems}"/>
                        
                    </ContextMenu>
                </DataGrid.ContextMenu>
                <DataGrid.RowStyle>
                    <Style TargetType="DataGridRow">
                        <EventSetter Event="MouseDoubleClick" Handler="DataGridRow_MouseDoubleClick"/>
                        <Setter Property="Background" Value="White"/>
                        <!-- 默认行背景色 -->
                        <Style.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <!-- 选中时的背景色和前景色 -->
                                <Setter Property="Background" Value="#0078D7"/>
                                <Setter Property="Foreground" Value="White"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.RowStyle>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="用户名" Binding="{Binding Username}" Width="auto"/>
                    <DataGridCheckBoxColumn Header="二级" Binding="{Binding IsPrime}" Width="auto"/>
                    <DataGridTextColumn Header="状态" Binding="{Binding DisplayStatus}"  Width="auto"/>
                    <DataGridTextColumn Header="备注 / 其他信息" Binding="{Binding Nickname}" Width="auto"/>
                    <DataGridTextColumn Header="SteamID64" Binding="{Binding SteamID64}" Width="auto"/>
                </DataGrid.Columns>
            </DataGrid>
        </DockPanel>
    </DockPanel>
</Window>